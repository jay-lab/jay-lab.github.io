---
layout: single
title: "Python Injection 대응"
categories: python
# tag: python
tag: [python, Injection]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---

  

# Injection

Injetion : 악의적인 사용자가 보안상의 취약점을 이용하여, 임의의 SQL 문을 주입하고 실행되게 하여 데이터베이스가 비정상적인 동작을 하도록 조작하는 행위

라고 정의하고 있다. 내가 실무에서 접하게된 상황은 고객사 측 보안팀에서 모의해킹 테스트 과정 중 Injection 공격을 시도 후 이에 대한 조치를 요구했을 때였다. 해당 보안팀에서는 홑따옴표(') 혹은 주석(--)과 같은 문자를 활용한 쿼리 일부를  DB와 통신하는 API의 인자값으로 넘겨서 모의해킹을 진행하는 것을 알게된 것이 injection을 알게된 계기였다.

### Injection 공격 예시

```javascript
'https://testurl.com/testAPI' // 이러한 API url에 
{ testKey : "testValue" } // 이 인자값을 POST 방식으로 넘기는 것이 정상적인 방법일 때,

// 악의적인 사용자는 다음과 같이 인자값을 설정하여 쿼리를 조작할 수 있다. 
{ testKey : "testValue' and '이것이 해킹'='이것이해킹" }

```

정상적인 방법일 때는 실제 DB 쿼리 호출 부분에 다음과 같이 인자값이 설정 될 것이다.
`select * from testTable where key = 'testValue'`

비정상적인 케이스
`select * from testTable where key = 'testValue' and '이것이 해킹'='이것이해킹' `

위 둘은 같은 결과를 반환하겠지만, 모의해킹에서 저러한 파라미터를 넘겼음에도 정상적인 결과가 반환되었다는 것 자체로 Injection 공격에 뚤렸다는 의미

진짜 해커라면 이를 응용하여 DB를 마음껏 주무를 수 있다





### python에 대한 injection 방어 코드





# Issue

### 막상해보니 손 많이 가는 작업

대충봤을 때는 '반복작업만 하면 되는거 아니야?'싶은 작업이다. 내가 그랬으니까. injection 표준 대응방식으로 수정만 해주면 되는거라고 생각했지만 그게 아니었다.

쿼리에서 Argument값을 손보는 것은, 쿼리 실행 직전 부분의 흐름을 분석하고 영향도를 파악 후 작업해야하는 일이었다. 사실 이것도 시간만 있으면 쿼리 몇개쯤이야.. 하고 넘어갈 일이었는데 쿼리 당 들어가는 arg값이 적지 않았던 데다가 프로젝트 내에 사용되는 쿼리 전체를 수정해야했다. 그것도 '나 혼자'.. 수정해야할 CRUD 쿼리를 대략적으로 산정해보니 150개가 넘었다. 즉 최악에 상황은 150개의 쿼리문맥을 봐야하는 작업이라는 뜻.

나는 **사람**인지라 분명히 휴먼에러를 걱정할 수 밖에 없었으나 고객께서 제일 중요한 최종 요청이라하고.. 나중에 직접 전수검사를 하시겠다고 하고.. 시간도 넉넉히 준다고하고.. 꼭해야 오픈을 한다고 부탁하고.. 내가봐도 이게 마지막 요청이라 유종의 미를 거둬야 서로 좋을 것 같은 상황이고.. 이러니 뭐 끝까지 빼기가 참 곤란해서 결국 지금도 진행중이다..

### %()s.. 그럼 정수형은?

파이썬에서 %s는 문자형을 받을때 사용한다. 정수는 %d로 받는다.
그럼 Injection 대응할때 사용하는 것도 %(변수명)d 으로 되어야하는거 아닌가?
이와 관련된 문서는 찾지못했고, 직접해보며 확인한 결과 다음과 같이 알 수 있었다.

확인결과 : 문자형으로 넘겨주면 된다. 

1. DB에서 정수형을 받게끔 되어있더라도 문자형으로 만들어서 넘긴다.
2. 즉, Argument 부터 정수라면 문자열로 형변환해서 넘긴다.

그것을 %()s로 받아주면 된다.

ex)

```python
from psycopg2.extras import RealDictCursor
conn = psycopg2.connect("dbname={} user={} host={} password={}".format(db_name, db_user, db_host, db_pass))
cursor = conn.cursor(cursor_factory=RealDictCursor)


test = 1 # 대상 인자값

query = select * from testTable where key = %(str_test)s
query_paramDict = { 'str_test' : str(test) }

cursor.execute(query, query_paramDict)
```

