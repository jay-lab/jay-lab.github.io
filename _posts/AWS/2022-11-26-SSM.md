---
layout: single
title: "[AWS] Session Manager"
categories: [AWS]
tag: [VPC, TIL]
#toc: true
#toc_label: "Contents" # toc 제목
#toc_icon: "cog" # toc 아이콘(톱니바퀴)
author_profile: false
sidebar:
    nav: "docs"


---



**AWS Session Manager에 대하여.**

참고 영상 : https://youtu.be/mRq0VvXA-j8
{: .notice--info}



"Amazon Linux에는 기본적으로 ssm agent가 설치되어있기 때문에 iam role만 있으면 된다." 이 말은 즉, Amazon linux가 아니라면 ssm agent 별도 설치가 필요하다는 의미

역할(role) 생성:

- 해당 역할을 사용할 대상 : EC2

- 역할(role) 생성시 사용할 정책 중에는 "AmazonEC2RoleforSSM"이라는 정책 
- EC2에 이 role만 부여해주면 됨
- 실습간에는 EC2를 생성시 SSH포트(22)도 부여하지 않았고 키페어도 사용하지 않음으로 체크하여 생성하였다
- AWS Systems Manager 콘솔 화면 > Session Manager > 세션 시작
- `bash` > `sudo -s` > 정상 확인
- cloudwatch 로그그룹과 연결하여 서버 내에서 어떤 유저가 어떤 작업을 했는지에 대한 로그를 기록 가능



### SSM + Lambda를 사용하여 EC2 특정시간에 켜고 끄기

1. iam > 역할생성 > 
   1. 역할 사용 대상 : SystemManager
   2. 사용할 정책 : AmazonSSMAutomationRole
   3. 역할 이름 : MySSMAutomationRole
2. Lambda를 위한 role 생성
   1. 역할 이름 : MyEC2StartStopRole
   2. 인라인 정책 내용 : https://youtu.be/mRq0VvXA-j8?t=420
   3. 1단계에서 생성한 'MySSMAutomationRole' role의 arn 사용
3. Lambda 생성
   1. 역할 설정시 위 2단계에서 생성한 'MyEC2StartStopRole' role 선택
   2. Labmda 내용 : https://youtu.be/mRq0VvXA-j8?t=488
   3. 파라미터는 타겟 EC2가 가지고 있는 tag의 key, value 그리고 1단계 role 'MySSMAutomationRole', 그리고 'stop' 혹은 'start'
   4. 이렇게 test를 진행하면 EC2의 시작과 종료 권한을 가지고 있는 lambda가 SSM에 기능을 위임 > session manager에게 'MySSMAutomationRole' role의 arn을 짚어주며  '자동화'에 대한 명령을 실행하라고 명령.
4. CloudWatch 규칙 생성
